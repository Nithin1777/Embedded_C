#include "stm32f4xx.h"

/*Tested with ARM Compiler : version 5*/


//Connect a jumper to PA5 to PA6.
int timestamp = 0;

int main(void) {

    RCC->AHB1ENR |=  1;             /* enable GPIOA clock */
    GPIOA->MODER |=  0x800;    
    GPIOA->AFR[0] |= 0x00100000;    
    
    RCC->APB1ENR |= 1;              
    TIM2->PSC = 1600 - 1;           
    TIM2->ARR = 10000 - 1;          
    TIM2->CCMR1 = 0x30;             
		
    TIM2->CCR1 = 0;                 // set match value 
    TIM2->CCER |= 1;                // enable ch 1 compare mode 
    TIM2->CNT = 0;                  // clear counter 
    TIM2->CR1 = 1;                  // enable TIM2 
        
    // configure PA6 as input of TIM3 CH1
    RCC->AHB1ENR |=  1;             
    GPIOA->MODER |=  0x2000;         // set pin to alternate function 
    GPIOA->AFR[0] |= 0x02000000;    // set pin to AF2 for TIM3 CH1 

    RCC->APB1ENR |= 2;              
    TIM3->PSC = 16000 - 1;          
    TIM3->CCMR1 = 0x41;             
    TIM3->CCER = 1;                 
    TIM3->CR1 = 1;                  

    while (1) {
        while (!(TIM3->SR & 2)) {}  
        timestamp = TIM3->CCR1;   
    }
}

