#include "stm32f4xx.h"

/*Tested with ARM Compiler : version 5*/


void systickDelayMs(int n);
void LED_play(int value);



void USART2_init (void) {
    RCC->AHB1ENR |= 1;         
    RCC->APB1ENR |= 0x20000;    // Enable USART2 clock

    GPIOA->AFR[0] |=  0x7000;   // Alt7 for USART2 */
    GPIOA->MODER  |=  0x0080;   

    USART2->BRR = 0x008B;       // 115200 baud @ 16 MHz
    USART2->CR1 = 0x0004;       // Enable Rx, 8-bit data
    USART2->CR1 |= 0x2000;      // Enable USART2
}

void USART2_IRQHandler(void) {
    char c;

    if (USART2->SR & 0x0020) {
        c = USART2->DR;       
        LED_play(c);               
    }
}

void LED_play(int value) {
    value %= 16;                    /* cap the max count at 15 */

    for (; value > 0; value--) {
        GPIOA->BSRR = 0x00000020;   /* turn on LED */
        systickDelayMs(100);
        GPIOA->BSRR = 0x00200000;   /* turn off LED */
        systickDelayMs(100);
    }
    systickDelayMs(800);
}



void systickDelayMs(int n) {

    /* Configure SysTick */
    SysTick->LOAD = 16000;  // Reload with number of clocks per millisecond 
    SysTick->VAL = 0;       // Clear current value register 
    SysTick->CTRL = 0x5;    // Enable the timer 

    for(int i = 0; i < n; i++) {
		
		// Wait until the COUNTFLAG is set
        while((SysTick->CTRL & 0x10000) == 0) 
            { }
    }
    SysTick->CTRL = 0;      
}

